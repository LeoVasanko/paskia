import{_ as j,c as L,d as r,e as o,f as i,i as O,t as f,F as p,x as I,y as ee,k as ae,r as v,h as M,g as B,q as h,w as se,j as Ee,l as N,z,A as q,u as Q,B as X,o as Ne,C as Te,a as Ae,m as Me,b as Ie,v as Le}from"./_plugin-vue_export-helper-R4vr2A9I.js";import{u as ie,U as _e,_ as Ve,a as ze,R as qe,N as G,M as Be,b as je,L as Fe,A as xe,B as Ge,c as He}from"./AccessDenied-guOGfNm-.js";import"./helpers-CU0-cyzg.js";const Je={class:"permissions-section"},We={class:"actions"},Ye={class:"org-table"},Ze={key:0},Ke=["onClick"],Qe=["onClick"],Xe={class:"role-names"},ea={class:"center"},aa={key:0,class:"center"},sa=["onClick"],ia={key:0,class:"permissions-section"},ta={class:"matrix-wrapper"},na={class:"matrix-scroll"},oa=["title"],la=["title"],ra={class:"display-text"},da=["checked","onChange"],ua={class:"actions"},ma={class:"org-table"},ca={class:"perm-name-cell"},ga={class:"perm-title"},ya={class:"display-text"},va=["onClick"],pa={class:"perm-id-info"},fa={class:"id-text"},ha={class:"perm-members center"},$a={class:"perm-actions center"},ba=["onClick"],wa={__name:"AdminOverview",props:{info:Object,orgs:Array,permissions:Array,permissionSummary:Object},emits:["createOrg","openOrg","updateOrg","deleteOrg","toggleOrgPermission","openDialog","deletePermission","renamePermissionDisplay"],setup(a,{emit:C}){const D=a,U=L(()=>[...D.orgs].sort((m,s)=>{const t=m.display_name.localeCompare(s.display_name);return t!==0?t:m.uuid.localeCompare(s.uuid)})),k=L(()=>[...D.permissions].sort((m,s)=>m.id.localeCompare(s.id)));function R(m){return m.roles.slice().sort((s,t)=>s.display_name.localeCompare(t.display_name)).map(s=>s.display_name).join(", ")}return(m,s)=>(o(),r(p,null,[i("div",Je,[i("h2",null,f(a.info.is_global_admin?"Organizations":"Your Organizations"),1),i("div",We,[a.info.is_global_admin?(o(),r("button",{key:0,onClick:s[0]||(s[0]=t=>m.$emit("createOrg"))},"+ Create Org")):O("",!0)]),i("table",Ye,[i("thead",null,[i("tr",null,[s[2]||(s[2]=i("th",null,"Name",-1)),s[3]||(s[3]=i("th",null,"Roles",-1)),s[4]||(s[4]=i("th",null,"Members",-1)),a.info.is_global_admin?(o(),r("th",Ze,"Actions")):O("",!0)])]),i("tbody",null,[(o(!0),r(p,null,I(U.value,t=>(o(),r("tr",{key:t.uuid},[i("td",null,[i("a",{href:"#org/{{o.uuid}}",onClick:ae(u=>m.$emit("openOrg",t),["prevent"])},f(t.display_name),9,Ke),a.info.is_global_admin||a.info.is_org_admin?(o(),r("button",{key:0,onClick:u=>m.$emit("updateOrg",t),class:"icon-btn edit-org-btn","aria-label":"Rename organization",title:"Rename organization"},"✏️",8,Qe)):O("",!0)]),i("td",Xe,f(R(t)),1),i("td",ea,f(t.roles.reduce((u,c)=>u+c.users.length,0)),1),a.info.is_global_admin?(o(),r("td",aa,[i("button",{onClick:u=>m.$emit("deleteOrg",t),class:"icon-btn delete-icon","aria-label":"Delete organization",title:"Delete organization"},"❌",8,sa)])):O("",!0)]))),128))])])]),a.info.is_global_admin?(o(),r("div",ia,[s[8]||(s[8]=i("h2",null,"Permissions",-1)),i("div",ta,[i("div",na,[i("div",{class:"perm-matrix-grid",style:ee({gridTemplateColumns:"minmax(180px, 1fr) "+U.value.map(()=>"2.2rem").join(" ")})},[s[5]||(s[5]=i("div",{class:"grid-head perm-head"},"Permission",-1)),(o(!0),r(p,null,I(U.value,t=>(o(),r("div",{key:"head-"+t.uuid,class:"grid-head org-head",title:t.display_name},[i("span",null,f(t.display_name),1)],8,oa))),128)),(o(!0),r(p,null,I(k.value,t=>(o(),r(p,{key:t.id},[i("div",{class:"perm-name",title:t.id},[i("span",ra,f(t.display_name),1)],8,la),(o(!0),r(p,null,I(U.value,u=>(o(),r("div",{key:u.uuid+"-"+t.id,class:"matrix-cell"},[i("input",{type:"checkbox",checked:u.permissions.includes(t.id),onChange:c=>m.$emit("toggleOrgPermission",u,t.id,c.target.checked)},null,40,da)]))),128))],64))),128))],4)]),s[6]||(s[6]=i("p",{class:"matrix-hint muted"},"Toggle which permissions each organization can grant to its members.",-1))]),i("div",ua,[a.info.is_global_admin?(o(),r("button",{key:0,onClick:s[1]||(s[1]=t=>m.$emit("openDialog","perm-create",{display_name:"",id:""}))},"+ Create Permission")):O("",!0)]),i("table",ma,[s[7]||(s[7]=i("thead",null,[i("tr",null,[i("th",{scope:"col"},"Permission"),i("th",{scope:"col",class:"center"},"Members"),i("th",{scope:"col",class:"center"},"Actions")])],-1)),i("tbody",null,[(o(!0),r(p,null,I(k.value,t=>(o(),r("tr",{key:t.id},[i("td",ca,[i("div",ga,[i("span",ya,f(t.display_name),1),i("button",{onClick:u=>m.$emit("renamePermissionDisplay",t),class:"icon-btn edit-display-btn","aria-label":"Edit display name",title:"Edit display name"},"✏️",8,va)]),i("div",pa,[i("span",fa,f(t.id),1)])]),i("td",ha,f(a.permissionSummary[t.id]?.userCount||0),1),i("td",$a,[i("button",{onClick:u=>m.$emit("deletePermission",t),class:"icon-btn delete-icon","aria-label":"Delete permission",title:"Delete permission"},"❌",8,ba)])]))),128))])])])):O("",!0)],64))}},ka=j(wa,[["__scopeId","data-v-3b9e6d03"]]),Da=["title"],Oa={class:"org-name"},Ua={class:"matrix-wrapper"},Ca={class:"matrix-scroll"},Ra=["title"],Sa=["title"],Pa=["checked","onChange"],Ea={class:"roles-grid"},Na=["onDrop"],Ta={class:"role-header"},Aa=["title"],Ma=["onClick"],Ia={class:"role-actions"},La=["onClick"],_a={key:0,class:"user-list"},Va=["onDragstart","onClick","title"],za={class:"name"},qa={class:"meta"},Ba={key:1,class:"empty-role"},ja=["onClick"],Fa={__name:"AdminOrgDetail",props:{selectedOrg:Object,permissions:Array},emits:["updateOrg","createRole","updateRole","deleteRole","createUserInRole","openUser","toggleRolePermission","onRoleDragOver","onRoleDrop","onUserDragStart"],setup(a,{emit:C}){const D=a,U=C,k=L(()=>[...D.selectedOrg.roles].sort((s,t)=>{const u=s.display_name.toLowerCase(),c=t.display_name.toLowerCase();return u!==c?u.localeCompare(c):s.uuid.localeCompare(t.uuid)}));function R(s){return D.permissions.find(t=>t.id===s)?.display_name||s}function m(s,t,u){U("toggleRolePermission",s,t,u)}return(s,t)=>(o(),r(p,null,[i("h2",{class:"org-title",title:a.selectedOrg.uuid},[i("span",Oa,f(a.selectedOrg.display_name),1),i("button",{onClick:t[0]||(t[0]=u=>s.$emit("updateOrg",a.selectedOrg)),class:"icon-btn","aria-label":"Rename organization",title:"Rename organization"},"✏️")],8,Da),i("div",Ua,[i("div",Ca,[i("div",{class:"perm-matrix-grid",style:ee({gridTemplateColumns:"minmax(180px, 1fr) "+k.value.map(()=>"2.2rem").join(" ")+" 2.2rem"})},[t[4]||(t[4]=i("div",{class:"grid-head perm-head"},"Permission",-1)),(o(!0),r(p,null,I(k.value,u=>(o(),r("div",{key:"head-"+u.uuid,class:"grid-head role-head",title:u.display_name},[i("span",null,f(u.display_name),1)],8,Ra))),128)),i("div",{class:"grid-head role-head add-role-head",title:"Add role",onClick:t[1]||(t[1]=u=>s.$emit("createRole",a.selectedOrg)),role:"button"},"➕"),(o(!0),r(p,null,I(a.selectedOrg.permissions,u=>(o(),r(p,{key:u},[i("div",{class:"perm-name",title:u},f(R(u)),9,Sa),(o(!0),r(p,null,I(k.value,c=>(o(),r("div",{key:c.uuid+"-"+u,class:"matrix-cell"},[i("input",{type:"checkbox",checked:c.permissions.includes(u),onChange:S=>m(c,u,S.target.checked)},null,40,Pa)]))),128)),t[3]||(t[3]=i("div",{class:"matrix-cell add-role-cell"},null,-1))],64))),128))],4)]),t[5]||(t[5]=i("p",{class:"matrix-hint muted"},"Toggle which permissions each role grants.",-1))]),i("div",Ea,[(o(!0),r(p,null,I(k.value,u=>(o(),r("div",{key:u.uuid,class:"role-column",onDragover:t[2]||(t[2]=c=>s.$emit("onRoleDragOver",c)),onDrop:c=>s.$emit("onRoleDrop",c,a.selectedOrg,u)},[i("div",Ta,[i("strong",{class:"role-name",title:u.uuid},[i("span",null,f(u.display_name),1),i("button",{onClick:c=>s.$emit("updateRole",u),class:"icon-btn","aria-label":"Edit role",title:"Edit role"},"✏️",8,Ma)],8,Aa),i("div",Ia,[i("button",{onClick:c=>s.$emit("createUserInRole",a.selectedOrg,u),class:"plus-btn","aria-label":"Add user",title:"Add user"},"➕",8,La)])]),u.users.length>0?(o(),r("ul",_a,[(o(!0),r(p,null,I(u.users.slice().sort((c,S)=>{const b=c.display_name.toLowerCase(),g=S.display_name.toLowerCase();return b!==g?b.localeCompare(g):c.uuid.localeCompare(S.uuid)}),c=>(o(),r("li",{key:c.uuid,class:"user-chip",draggable:"true",onDragstart:S=>s.$emit("onUserDragStart",S,c,a.selectedOrg.uuid),onClick:S=>s.$emit("openUser",c),title:c.uuid},[i("span",za,f(c.display_name),1),i("span",qa,f(c.last_seen?new Date(c.last_seen).toLocaleDateString():"—"),1)],40,Va))),128))])):(o(),r("div",Ba,[t[6]||(t[6]=i("p",{class:"empty-text muted"},"No members",-1)),i("button",{onClick:c=>s.$emit("deleteRole",u),class:"icon-btn delete-icon","aria-label":"Delete empty role",title:"Delete role"},"❌",8,ja)]))],40,Na))),128))])],64))}},xa=j(Fa,[["__scopeId","data-v-b8b4bfbc"]]),Ga={class:"user-detail"},Ha={key:1,class:"error small"},Ja={class:"registration-actions"},Wa=["disabled"],Ya={class:"section-block","data-section":"registered-passkeys"},Za={class:"section-body"},Ka={class:"actions ancillary-actions"},Qa={__name:"AdminUserDetail",props:{selectedUser:Object,userDetail:Object,selectedOrg:Object,loading:Boolean,showRegModal:Boolean},emits:["generateUserRegistrationLink","goOverview","openOrg","onUserNameSaved","closeRegModal","editUserName","refreshUserDetail"],setup(a,{emit:C}){const D=a,U=C,k=ie(),R=v({}),m=v(null),s=v(null);function t(){k.showMessage("Link copied to clipboard!")}function u(){U("editUserName",D.selectedUser)}async function c(b){try{const g=await h(`/auth/api/admin/orgs/${D.selectedUser.org_uuid}/users/${D.selectedUser.uuid}/credentials/${b.credential_uuid}`,{method:"DELETE"});g.status==="ok"?U("onUserNameSaved"):console.error("Failed to delete credential",g)}catch(g){console.error("Delete credential error",g)}}async function S(b){const g=b?.id;if(g){R.value={...R.value,[g]:!0};try{const d=await h(`/auth/api/admin/orgs/${D.selectedUser.org_uuid}/users/${D.selectedUser.uuid}/sessions/${g}`,{method:"DELETE"});if(d.status==="ok"){if(d.current_session_terminated){sessionStorage.clear(),location.reload();return}U("refreshUserDetail"),k.showMessage("Session terminated","success",2500)}else k.showMessage(d.detail||"Failed to terminate session","error")}catch(d){console.error("Terminate session error",d),k.showMessage(d.message||"Failed to terminate session","error")}finally{const d={...R.value};delete d[g],R.value=d}}}return(b,g)=>(o(),r("div",Ga,[a.userDetail&&!a.userDetail.error?(o(),M(_e,{key:0,name:a.userDetail.display_name||a.selectedUser.display_name,visits:a.userDetail.visits,"created-at":a.userDetail.created_at,"last-seen":a.userDetail.last_seen,loading:a.loading,"org-display-name":a.userDetail.org.display_name,"role-name":a.userDetail.role,"update-endpoint":`/auth/api/admin/orgs/${a.selectedUser.org_uuid}/users/${a.selectedUser.uuid}/display-name`,onSaved:g[0]||(g[0]=d=>b.$emit("onUserNameSaved")),onEditName:u},null,8,["name","visits","created-at","last-seen","loading","org-display-name","role-name","update-endpoint"])):a.userDetail?.error?(o(),r("div",Ha,f(a.userDetail.error),1)):O("",!0),a.userDetail&&!a.userDetail.error?(o(),r(p,{key:2},[i("div",Ja,[i("button",{class:"btn-secondary reg-token-btn",onClick:g[1]||(g[1]=d=>b.$emit("generateUserRegistrationLink",a.selectedUser)),disabled:a.loading},"Generate Registration Token",8,Wa),g[6]||(g[6]=i("p",{class:"matrix-hint muted"}," Generate a one-time registration link so this user can register or add another passkey. Copy the link from the dialog and send it to the user, or have the user scan the QR code on their device. ",-1))]),i("section",Ya,[g[7]||(g[7]=i("div",{class:"section-header"},[i("h2",null,"Registered Passkeys")],-1)),i("div",Za,[B(Ve,{credentials:a.userDetail.credentials,"aaguid-info":a.userDetail.aaguid_info,"allow-delete":!0,"hovered-credential-uuid":m.value,"hovered-session-credential-uuid":s.value?.credential_uuid,onDelete:c,onCredentialHover:g[2]||(g[2]=d=>m.value=d)},null,8,["credentials","aaguid-info","hovered-credential-uuid","hovered-session-credential-uuid"])])]),B(ze,{sessions:a.userDetail.sessions||[],"terminating-sessions":R.value,"hovered-credential-uuid":m.value,"empty-message":"This user has no active sessions.","section-description":"View and manage the active sessions for this user.",onTerminate:S,onSessionHover:g[3]||(g[3]=d=>s.value=d)},null,8,["sessions","terminating-sessions","hovered-credential-uuid"])],64)):O("",!0),i("div",Ka,[a.selectedOrg?(o(),r("button",{key:0,onClick:g[4]||(g[4]=d=>b.$emit("openOrg",a.selectedOrg)),class:"icon-btn",title:"Back to Org"},"↩️")):O("",!0)]),a.showRegModal?(o(),M(qe,{key:3,endpoint:`/auth/api/admin/orgs/${a.selectedUser.org_uuid}/users/${a.selectedUser.uuid}/create-link`,"auto-copy":!1,"user-name":a.userDetail?.display_name||a.selectedUser.display_name,onClose:g[5]||(g[5]=d=>b.$emit("closeRegModal")),onCopied:t},null,8,["endpoint","user-name"])):O("",!0)]))}},Xa=j(Qa,[["__scopeId","data-v-9226fea7"]]),es={class:"modal-title"},as={key:0},ss={key:2},is={class:"small muted"},ts=["placeholder","pattern"],ns={key:7},os={key:8,class:"error small"},ls={key:9,class:"modal-actions"},rs=["disabled"],ds=["disabled"],us={__name:"AdminDialogs",props:{dialog:Object,PERMISSION_ID_PATTERN:String},emits:["submitDialog","closeDialog"],setup(a,{emit:C}){const D=a,U=v(null),k=v(null),R=new Set(["org-update","role-update","user-update-name"]);return se(()=>D.dialog.type,m=>{m==="org-create"?X(()=>{U.value?.focus()}):(m==="perm-display"||m==="perm-create")&&X(()=>{k.value?.focus(),m==="perm-display"&&k.value?.select()})}),(m,s)=>a.dialog.type?(o(),M(Be,{key:0,onClose:s[13]||(s[13]=t=>m.$emit("closeDialog"))},{default:Ee(()=>[i("h3",es,[a.dialog.type==="org-create"?(o(),r(p,{key:0},[N("Create Organization")],64)):a.dialog.type==="org-update"?(o(),r(p,{key:1},[N("Rename Organization")],64)):a.dialog.type==="role-create"?(o(),r(p,{key:2},[N("Create Role")],64)):a.dialog.type==="role-update"?(o(),r(p,{key:3},[N("Edit Role")],64)):a.dialog.type==="user-create"?(o(),r(p,{key:4},[N("Add User To Role")],64)):a.dialog.type==="user-update-name"?(o(),r(p,{key:5},[N("Edit User Name")],64)):a.dialog.type==="perm-create"||a.dialog.type==="perm-display"?(o(),r(p,{key:6},[N(f(a.dialog.type==="perm-create"?"Create Permission":"Edit Permission Display"),1)],64)):a.dialog.type==="confirm"?(o(),r(p,{key:7},[N("Confirm")],64)):O("",!0)]),i("form",{onSubmit:s[12]||(s[12]=ae(t=>m.$emit("submitDialog"),["prevent"])),class:"modal-form"},[a.dialog.type==="org-create"?(o(),r("label",as,[s[14]||(s[14]=N("Name ",-1)),z(i("input",{ref_key:"nameInput",ref:U,"onUpdate:modelValue":s[0]||(s[0]=t=>a.dialog.data.name=t),required:""},null,512),[[q,a.dialog.data.name]])])):a.dialog.type==="org-update"?(o(),M(G,{key:1,label:"Organization Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":s[1]||(s[1]=t=>a.dialog.data.name=t),busy:a.dialog.busy,error:a.dialog.error,onCancel:s[2]||(s[2]=t=>m.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="role-create"?(o(),r("label",ss,[s[15]||(s[15]=N("Role Name ",-1)),z(i("input",{"onUpdate:modelValue":s[3]||(s[3]=t=>a.dialog.data.name=t),placeholder:"Role name",required:""},null,512),[[q,a.dialog.data.name]])])):a.dialog.type==="role-update"?(o(),M(G,{key:3,label:"Role Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":s[4]||(s[4]=t=>a.dialog.data.name=t),busy:a.dialog.busy,error:a.dialog.error,onCancel:s[5]||(s[5]=t=>m.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="user-create"?(o(),r(p,{key:4},[i("p",is,"Role: "+f(a.dialog.data.role.display_name),1),i("label",null,[s[16]||(s[16]=N("Display Name ",-1)),z(i("input",{"onUpdate:modelValue":s[6]||(s[6]=t=>a.dialog.data.name=t),placeholder:"User display name",required:""},null,512),[[q,a.dialog.data.name]])])],64)):a.dialog.type==="user-update-name"?(o(),M(G,{key:5,label:"Display Name",modelValue:a.dialog.data.name,"onUpdate:modelValue":s[7]||(s[7]=t=>a.dialog.data.name=t),busy:a.dialog.busy,error:a.dialog.error,onCancel:s[8]||(s[8]=t=>m.$emit("closeDialog"))},null,8,["modelValue","busy","error"])):a.dialog.type==="perm-create"||a.dialog.type==="perm-display"?(o(),r(p,{key:6},[i("label",null,[s[17]||(s[17]=N("Display Name ",-1)),z(i("input",{ref_key:"displayNameInput",ref:k,"onUpdate:modelValue":s[9]||(s[9]=t=>a.dialog.data.display_name=t),required:""},null,512),[[q,a.dialog.data.display_name]])]),i("label",null,[s[18]||(s[18]=N("Permission ID ",-1)),z(i("input",{"onUpdate:modelValue":s[10]||(s[10]=t=>a.dialog.data.id=t),placeholder:a.dialog.type==="perm-create"?"yourapp:login":a.dialog.data.permission.id,required:"",pattern:a.PERMISSION_ID_PATTERN,title:"Allowed: A-Za-z0-9:._~-"},null,8,ts),[[q,a.dialog.data.id]])]),s[19]||(s[19]=i("p",{class:"small muted"},"The permission ID is used for permission checks in the application. Changing it may break deployed applications that reference this permission.",-1))],64)):a.dialog.type==="confirm"?(o(),r("p",ns,f(a.dialog.data.message),1)):O("",!0),a.dialog.error&&!Q(R).has(a.dialog.type)?(o(),r("div",os,f(a.dialog.error),1)):O("",!0),Q(R).has(a.dialog.type)?O("",!0):(o(),r("div",ls,[i("button",{type:"button",class:"btn-secondary",onClick:s[11]||(s[11]=t=>m.$emit("closeDialog")),disabled:a.dialog.busy}," Cancel ",8,rs),i("button",{type:"submit",class:"btn-primary",disabled:a.dialog.busy},f(a.dialog.type==="confirm"?"OK":"Save"),9,ds)]))],32)]),_:1})):O("",!0)}},ms=j(us,[["__scopeId","data-v-42b70397"]]),cs={class:"app-shell admin-shell"},gs={class:"app-main"},ys={key:2,class:"view-root view-root--wide view-admin"},vs={class:"view-header"},ps={class:"section-block admin-section"},fs={class:"section-body admin-section-body"},hs={key:0,class:"surface surface--tight error"},$s={key:1,class:"admin-panels"},bs="^[A-Za-z0-9:._~-]+$",ws={__name:"AdminApp",setup(a){const C=v(null),D=v(!0),U=v("Loading..."),k=v(!1),R=v(!1),m=v(null),s=v([]),t=v([]),u=v(null),c=v(null),S=v(null);v(null),v(null);const b=ie(),g=v(null);v(null),v(""),v(null),v("");const d=v({type:null,data:null,busy:!1,error:""});function H(e){if(!g.value)return;const n=e.target.closest(".org-add-menu"),l=e.target.closest(".add-org-btn");!n&&!l&&(g.value=null)}Ne(async()=>{document.addEventListener("click",H),window.addEventListener("hashchange",F);const e=await Te();e?.rp_name&&(document.title=e.rp_name+" Admin"),await re()}),Ae(()=>{document.removeEventListener("click",H),window.removeEventListener("hashchange",F)});const ne=L(()=>{const e={};for(const l of s.value){const y={uuid:l.uuid,display_name:l.display_name},$=new Set(l.permissions||[]);for(const w of l.permissions||[])e[w]||(e[w]={orgs:[],orgSet:new Set,userCount:0}),e[w].orgSet.has(l.uuid)||(e[w].orgs.push(y),e[w].orgSet.add(l.uuid));for(const w of l.roles)for(const E of w.permissions)$.has(E)&&(e[E]||(e[E]={orgs:[],orgSet:new Set,userCount:0}),e[E].orgSet.has(l.uuid)||(e[E].orgs.push(y),e[E].orgSet.add(l.uuid)),e[E].userCount+=w.users.length)}const n={};for(const[l,y]of Object.entries(e))n[l]={orgs:y.orgs.sort(($,w)=>$.display_name.localeCompare(w.display_name)),userCount:y.userCount};return n});function oe(e){A("perm-display",{permission:e,id:e.id,display_name:e.display_name})}function F(){const e=window.location.hash||"";u.value=null,c.value=null,e.startsWith("#org/")?u.value=e.slice(5):e.startsWith("#user/")&&(c.value=e.slice(6))}async function T(){const e=await h("/auth/api/admin/orgs");s.value=e.map(n=>{const l=n.roles.map($=>({...$,org_uuid:n.uuid,users:[]})),y=Object.fromEntries(l.map($=>[$.display_name,$]));for(const $ of n.users||[])y[$.role]&&y[$.role].users.push($);return{...n,roles:l}})}async function _(){t.value=await h("/auth/api/admin/permissions")}async function le(){C.value=await h("/auth/api/user-info",{method:"POST"}),k.value=!0}async function re(){D.value=!0,U.value="Loading...",m.value=null;try{await Promise.all([T(),_()]),await le(),!C.value.is_global_admin&&C.value.is_org_admin&&s.value.length===1&&(!window.location.hash||window.location.hash==="#overview")?(u.value=s.value[0].uuid,window.location.hash=`#org/${u.value}`,b.showMessage(`Navigating to ${s.value[0].display_name} Administration`,"info",3e3)):F()}catch(e){e.name==="AuthCancelledError"?R.value=!0:m.value=e.message}finally{D.value=!1}}function de(){A("org-create",{})}function J(e){A("org-update",{org:e,name:e.display_name})}function ue(e){A("user-update-name",{user:e,name:e.display_name})}function me(e){if(!C.value?.is_global_admin){b.showMessage("Global admin only");return}A("confirm",{message:`Delete organization ${e.display_name}?`,action:async()=>{await h(`/auth/api/admin/orgs/${e.uuid}`,{method:"DELETE"}),await Promise.all([T(),_()])}})}function ce(e,n){A("user-create",{org:e,role:n})}async function ge(e,n,l){if(n.role!==l)try{await h(`/auth/api/admin/orgs/${e.uuid}/users/${n.uuid}/role`,{method:"PUT",body:{role:l}}),await T()}catch(y){b.showMessage(y.message||"Failed to update user role")}}function ye(e,n,l){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",JSON.stringify({user_uuid:n.uuid,org_uuid:l}))}function ve(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function pe(e,n,l){e.preventDefault();try{const y=JSON.parse(e.dataTransfer.getData("text/plain"));if(y.org_uuid!==n.uuid)return;const $=n.roles.flatMap(w=>w.users).find(w=>w.uuid===y.user_uuid);$&&ge(n,$,l.display_name)}catch{}}function fe(e){A("role-create",{org:e})}function he(e){A("role-update",{role:e,name:e.display_name})}function $e(e){A("confirm",{message:`Delete role ${e.display_name}?`,action:async()=>{await h(`/auth/api/admin/orgs/${e.org_uuid}/roles/${e.uuid}`,{method:"DELETE"}),await T()}})}async function be(e,n,l){const y=l?[...e.permissions,n]:e.permissions.filter(w=>w!==n),$=[...e.permissions];e.permissions=y;try{await h(`/auth/api/admin/orgs/${e.org_uuid}/roles/${e.uuid}`,{method:"PUT",body:{display_name:e.display_name,permissions:y}}),await T()}catch(w){b.showMessage(w.message||"Failed to update role permission"),e.permissions=$}}function we(e){A("confirm",{message:`Delete permission ${e.id}?`,action:async()=>{const n=new URLSearchParams({permission_id:e.id});await h(`/auth/api/admin/permission?${n.toString()}`,{method:"DELETE"}),await _()}})}function ke(){window.location.reload()}const V=L(()=>s.value.find(e=>e.uuid===u.value)||null);function W(e){window.location.hash=`#org/${e.uuid}`}function De(){window.location.hash="#overview"}function Oe(e){window.location.hash=`#user/${e.uuid}`}const P=L(()=>{if(!c.value)return null;for(const e of s.value)for(const n of e.roles){const l=n.users.find(y=>y.uuid===c.value);if(l)return{...l,org_uuid:e.uuid,role_display_name:n.display_name}}return null}),Ue=L(()=>P.value?"Admin: User":V.value?"Admin: Org":(b.settings?.rp_name||"Master")+" Admin"),Ce=L(()=>{const e=[{label:"Auth",href:Me()},{label:"Admin",href:Ie()}];let n=null;P.value&&(n=s.value.find(y=>y.uuid===P.value.org_uuid)||null);const l=V.value||n;return l&&e.push({label:l.display_name,href:`#org/${l.uuid}`}),P.value&&e.push({label:P.value.display_name||"User",href:`#user/${P.value.uuid}`}),e});se(P,async e=>{if(!e){S.value=null;return}try{S.value=await h(`/auth/api/admin/orgs/${e.org_uuid}/users/${e.uuid}`)}catch(n){S.value={error:n.message}}});const x=v(!1);function Re(e){x.value=!0}async function Se(e,n,l){const y=e.permissions.includes(n);if(l&&y||!l&&!y)return;const $=l?[...e.permissions,n]:e.permissions.filter(E=>E!==n),w=[...e.permissions];e.permissions=$;try{const E=new URLSearchParams({permission_id:n});await h(`/auth/api/admin/orgs/${e.uuid}/permission?${E.toString()}`,{method:l?"POST":"DELETE"}),await T()}catch(E){b.showMessage(E.message||"Failed to update organization permission"),e.permissions=w}}function A(e,n){d.value={type:e,data:n,busy:!1,error:""}}function Y(){d.value={type:null,data:null,busy:!1,error:""}}async function Z(){if(await T(),P.value)try{S.value=await h(`/auth/api/admin/orgs/${P.value.org_uuid}/users/${P.value.uuid}`)}catch(e){b.showMessage(e.message||"Failed to reload user","error")}}async function K(){await Z(),b.showMessage("User renamed","success",1500)}async function Pe(){if(!(!d.value.type||d.value.busy)){d.value.busy=!0,d.value.error="";try{const e=d.value.type;if(e==="org-create"){const n=d.value.data.name?.trim();if(!n)throw new Error("Name required");await h("/auth/api/admin/orgs",{method:"POST",body:{display_name:n,permissions:[]}}),await Promise.all([T(),_()])}else if(e==="org-update"){const{org:n}=d.value.data,l=d.value.data.name?.trim();if(!l)throw new Error("Name required");await h(`/auth/api/admin/orgs/${n.uuid}`,{method:"PUT",body:{display_name:l,permissions:n.permissions}}),await T()}else if(e==="role-create"){const{org:n}=d.value.data,l=d.value.data.name?.trim();if(!l)throw new Error("Name required");await h(`/auth/api/admin/orgs/${n.uuid}/roles`,{method:"POST",body:{display_name:l,permissions:[]}}),await T()}else if(e==="role-update"){const{role:n}=d.value.data,l=d.value.data.name?.trim();if(!l)throw new Error("Name required");await h(`/auth/api/admin/orgs/${n.org_uuid}/roles/${n.uuid}`,{method:"PUT",body:{display_name:l,permissions:n.permissions}}),await T()}else if(e==="user-create"){const{org:n,role:l}=d.value.data,y=d.value.data.name?.trim();if(!y)throw new Error("Name required");await h(`/auth/api/admin/orgs/${n.uuid}/users`,{method:"POST",body:{display_name:y,role:l.display_name}}),await T()}else if(e==="user-update-name"){const{user:n}=d.value.data,l=d.value.data.name?.trim();if(!l)throw new Error("Name required");await h(`/auth/api/admin/orgs/${n.org_uuid}/users/${n.uuid}/display-name`,{method:"PUT",body:{display_name:l}}),await K()}else if(e==="perm-display"){const{permission:n}=d.value.data,l=d.value.data.id?.trim(),y=d.value.data.display_name?.trim();if(!y)throw new Error("Display name required");if(!l)throw new Error("ID required");if(l!==n.id)await h("/auth/api/admin/permission/rename",{method:"POST",body:{old_id:n.id,new_id:l,display_name:y}});else if(y!==n.display_name){const $=new URLSearchParams({permission_id:n.id,display_name:y});await h(`/auth/api/admin/permission?${$.toString()}`,{method:"PUT"})}await _()}else if(e==="perm-create"){const n=d.value.data.id?.trim();if(!n)throw new Error("ID required");const l=d.value.data.display_name?.trim();if(!l)throw new Error("Display name required");await h("/auth/api/admin/permissions",{method:"POST",body:{id:n,display_name:l}}),await _(),d.value.data.display_name="",d.value.data.id=""}else if(e==="confirm"){const n=d.value.data.action;n&&await n()}Y()}catch(e){d.value.error=e.message||"Error"}finally{d.value.busy=!1}}}return(e,n)=>(o(),r("div",cs,[B(je),i("main",gs,[D.value?(o(),M(Fe,{key:0,message:U.value},null,8,["message"])):R.value?(o(),M(xe,{key:1,onReload:ke})):k.value&&(C.value?.is_global_admin||C.value?.is_org_admin)?(o(),r("section",ys,[i("header",vs,[i("h1",null,f(Ue.value),1),B(Ge,{entries:Ce.value},null,8,["entries"])]),i("section",ps,[i("div",fs,[m.value?(o(),r("div",hs,f(m.value),1)):(o(),r("div",$s,[!P.value&&!V.value&&(C.value.is_global_admin||C.value.is_org_admin)?(o(),M(ka,{key:0,info:C.value,orgs:s.value,permissions:t.value,"permission-summary":ne.value,onCreateOrg:de,onOpenOrg:W,onUpdateOrg:J,onDeleteOrg:me,onToggleOrgPermission:Se,onOpenDialog:A,onDeletePermission:we,onRenamePermissionDisplay:oe},null,8,["info","orgs","permissions","permission-summary"])):P.value?(o(),M(Xa,{key:1,"selected-user":P.value,"user-detail":S.value,"selected-org":V.value,loading:D.value,"show-reg-modal":x.value,onGenerateUserRegistrationLink:Re,onGoOverview:De,onOpenOrg:W,onOnUserNameSaved:K,onRefreshUserDetail:Z,onEditUserName:ue,onCloseRegModal:n[0]||(n[0]=l=>x.value=!1)},null,8,["selected-user","user-detail","selected-org","loading","show-reg-modal"])):V.value?(o(),M(xa,{key:2,"selected-org":V.value,permissions:t.value,onUpdateOrg:J,onCreateRole:fe,onUpdateRole:he,onDeleteRole:$e,onCreateUserInRole:ce,onOpenUser:Oe,onToggleRolePermission:be,onOnRoleDragOver:ve,onOnRoleDrop:pe,onOnUserDragStart:ye},null,8,["selected-org","permissions"])):O("",!0)]))])])])):O("",!0)]),B(ms,{dialog:d.value,"permission-id-pattern":bs,onSubmitDialog:Pe,onCloseDialog:Y},null,8,["dialog"])]))}},ks=j(ws,[["__scopeId","data-v-c67ea2c5"]]),te=Le(ks);te.use(He());te.mount("#admin-app");
