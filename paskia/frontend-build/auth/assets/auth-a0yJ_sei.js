import{_ as F,r as m,w as Y,o as T,a as z,c as v,m as O,b as j,d as k,e as l,f as t,g as N,h as $,i as C,u as o,j as J,k as K,n as G,F as Q,l as H,t as b,p as X,q as E,s as Z,v as ee}from"./_plugin-vue_export-helper-R4vr2A9I.js";import{u as x,B as se,U as R,_ as te,a as oe,N as ae,M as ne,R as ie,L as le,b as re,A as ue,c as de}from"./AccessDenied-guOGfNm-.js";import{g as U}from"./helpers-CU0-cyzg.js";const ce={class:"view-root","data-view":"profile"},ve={class:"view-header"},fe={class:"section-block"},ge={class:"section-block"},me={class:"section-body"},pe={class:"button-row"},he={class:"section-block"},ye=["disabled"],we=["disabled"],_e=["disabled"],be={key:0,class:"logout-note"},ke={key:1,class:"logout-note"},Ie={__name:"ProfileView",setup(V){const e=x(),f=m(null),r=m(!1),p=m(!1),y=m(""),w=m(!1),A=m(null),_=m(null);Y(r,d=>{d&&(y.value=e.userInfo?.user?.user_name||"")}),T(()=>{f.value=setInterval(()=>{e.userInfo&&(e.userInfo={...e.userInfo})},6e4)}),z(()=>{f.value&&clearInterval(f.value)});const c=async()=>{try{await X.register(null,null,()=>{e.showMessage("Adding new passkey...","info")}),await e.loadUserInfo(),e.showMessage("New passkey added successfully!","success",3e3)}catch(d){console.error("Failed to add new passkey:",d),e.showMessage(d.message,"error")}},S=async d=>{const s=d?.credential_uuid;if(s&&confirm("Are you sure you want to delete this passkey?"))try{await e.deleteCredential(s),e.showMessage("Passkey deleted successfully!","success",3e3)}catch(n){e.showMessage(`Failed to delete passkey: ${n.message}`,"error")}},L=v(()=>e.settings?.rp_name||"this service"),u=v(()=>e.userInfo?.sessions||[]),i=v(()=>u.value.find(s=>s.is_current)?.host||"this host"),h=m({}),B=async d=>{const s=d?.id;if(s){h.value={...h.value,[s]:!0};try{await e.terminateSession(s)}catch(n){e.showMessage(n.message||"Failed to terminate session","error",5e3)}finally{const n={...h.value};delete n[s],h.value=n}}},P=async()=>{await e.logoutEverywhere()},M=async()=>{await e.logout()},a=()=>{y.value=e.userInfo?.user?.user_name||"",r.value=!0},g=v(()=>!!(e.userInfo?.is_global_admin||e.userInfo?.is_org_admin)),I=v(()=>u.value.length>1),D=v(()=>{const d=[{label:"Auth",href:O()}];return g.value&&d.push({label:"Admin",href:j()}),d}),W=async()=>{const d=y.value.trim();if(!d){e.showMessage("Name cannot be empty","error");return}try{w.value=!0,await E("/auth/api/user/display-name",{method:"PUT",body:{display_name:d}}),r.value=!1,await e.loadUserInfo(),e.showMessage("Name updated successfully!","success",3e3)}catch(s){e.showMessage(s.message||"Failed to update name","error")}finally{w.value=!1}};return(d,s)=>(l(),k("section",ce,[t("header",ve,[s[10]||(s[10]=t("h1",null,"ðŸ‘‹ Welcome!",-1)),N(se,{entries:D.value},null,8,["entries"]),s[11]||(s[11]=t("p",{class:"view-lede"},"Manage your account details and passkeys.",-1))]),t("section",fe,[o(e).userInfo?.user?(l(),$(R,{key:0,name:o(e).userInfo.user.user_name,visits:o(e).userInfo.user.visits||0,"created-at":o(e).userInfo.user.created_at,"last-seen":o(e).userInfo.user.last_seen,loading:o(e).isLoading,"update-endpoint":"/auth/api/user/display-name",onSaved:s[0]||(s[0]=n=>o(e).loadUserInfo()),onEditName:a},null,8,["name","visits","created-at","last-seen","loading"])):C("",!0)]),t("section",ge,[s[12]||(s[12]=t("div",{class:"section-header"},[t("h2",null,"Your Passkeys"),t("p",{class:"section-description"},"Keep at least one trusted passkey so you can always sign in.")],-1)),t("div",me,[N(te,{credentials:o(e).userInfo?.credentials||[],"aaguid-info":o(e).userInfo?.aaguid_info||{},loading:o(e).isLoading,"hovered-credential-uuid":A.value,"hovered-session-credential-uuid":_.value?.credential_uuid,"allow-delete":"",onDelete:S,onCredentialHover:s[1]||(s[1]=n=>A.value=n)},null,8,["credentials","aaguid-info","loading","hovered-credential-uuid","hovered-session-credential-uuid"]),t("div",pe,[t("button",{onClick:c,class:"btn-primary"},"Add New Passkey"),t("button",{onClick:s[2]||(s[2]=n=>p.value=!0),class:"btn-secondary"},"Add Another Device")])])]),N(oe,{sessions:u.value,"terminating-sessions":h.value,"hovered-credential-uuid":A.value,onTerminate:B,onSessionHover:s[3]||(s[3]=n=>_.value=n),"section-description":"Review where you're signed in and end any sessions you no longer recognize."},null,8,["sessions","terminating-sessions","hovered-credential-uuid"]),r.value?(l(),$(ne,{key:0,onClose:s[6]||(s[6]=n=>r.value=!1)},{default:J(()=>[s[13]||(s[13]=t("h3",null,"Edit Display Name",-1)),t("form",{onSubmit:K(W,["prevent"]),class:"modal-form"},[N(ae,{label:"Display Name",modelValue:y.value,"onUpdate:modelValue":s[4]||(s[4]=n=>y.value=n),busy:w.value,onCancel:s[5]||(s[5]=n=>r.value=!1)},null,8,["modelValue","busy"])],32)]),_:1})):C("",!0),t("section",he,[t("div",{class:G(["button-row logout-row",{single:!I.value}])},[t("button",{type:"button",class:"btn-secondary",onClick:s[7]||(s[7]=(...n)=>o(U)&&o(U)(...n))}," Back "),I.value?(l(),k(Q,{key:1},[t("button",{onClick:M,class:"btn-danger logout-button",disabled:o(e).isLoading},"Logout",8,we),t("button",{onClick:P,class:"btn-danger logout-button",disabled:o(e).isLoading},"All",8,_e)],64)):(l(),k("button",{key:0,onClick:P,class:"btn-danger logout-button",disabled:o(e).isLoading},"Logout",8,ye))],2),I.value?(l(),k("p",ke,[s[15]||(s[15]=t("strong",null,"Logout",-1)),H(" this session on "+b(i.value)+", or ",1),s[16]||(s[16]=t("strong",null,"All",-1)),H(" sessions across all sites and devices for "+b(L.value)+". You'll need to log in again with your passkey afterwards.",1)])):(l(),k("p",be,[s[14]||(s[14]=t("strong",null,"Logout",-1)),H(" from "+b(i.value)+".",1)]))]),p.value?(l(),$(ie,{key:1,endpoint:"/auth/api/user/create-link","auto-copy":!1,"prefix-copy-with-user-name":!1,onClose:s[8]||(s[8]=n=>p.value=!1),onCopied:s[9]||(s[9]=n=>{p.value=!1,o(e).showMessage("Link copied to clipboard!","success",2500)})})):C("",!0)]))}},$e=F(Ie,[["__scopeId","data-v-0cc830bd"]]),Ae={class:"view-root host-view","data-view":"host-profile"},Se={class:"view-header"},Le={class:"view-lede"},Me={class:"section-block"},Ne={class:"section-body"},Ce={key:1,class:"empty-state"},He={class:"section-block"},Pe={class:"section-body host-actions"},Ue={class:"button-row"},Ve=["disabled"],Be=["disabled"],De={class:"note"},Ee={__name:"HostProfileView",props:{initializing:{type:Boolean,default:!1}},setup(V){const e=x(),f=window.location.host,r=v(()=>e.userInfo?.user||null),p=v(()=>e.userInfo?.org?.display_name||""),y=v(()=>e.userInfo?.role?.display_name||""),w=v(()=>{const u=e.settings?.rp_name;return u?`${u} account`:"Account overview"}),A=v(()=>`You're signed in to ${f}.`),_=v(()=>e.settings?.auth_host||""),c=v(()=>{const u=_.value;if(!u)return"";let i=e.settings?.ui_base_path??"/auth/";return i.startsWith("/")||(i=`/${i}`),i.endsWith("/")||(i=`${i}/`),`${window.location.protocol||"https:"}//${u}${i}`}),S=()=>{c.value&&(window.location.href=c.value)},L=async()=>{await e.logout()};return(u,i)=>(l(),k("section",Ae,[t("header",Se,[t("h1",null,b(w.value),1),t("p",Le,b(A.value),1)]),t("section",Me,[t("div",Ne,[r.value?(l(),$(R,{key:0,name:r.value.user_name,visits:r.value.visits||0,"created-at":r.value.created_at,"last-seen":r.value.last_seen,"org-display-name":p.value,"role-name":y.value,"can-edit":!1},null,8,["name","visits","created-at","last-seen","org-display-name","role-name"])):(l(),k("p",Ce,b(V.initializing?"Loading your accountâ€¦":"No active session found."),1))])]),t("section",He,[t("div",Pe,[t("div",Ue,[t("button",{type:"button",class:"btn-secondary",onClick:i[0]||(i[0]=(...h)=>o(U)&&o(U)(...h))}," Back "),t("button",{type:"button",class:"btn-danger",disabled:o(e).isLoading,onClick:L},b(o(e).isLoading?"Signing outâ€¦":"Logout"),9,Ve),c.value?(l(),k("button",{key:0,type:"button",class:"btn-primary",disabled:o(e).isLoading,onClick:S}," Full Profile ",8,Be)):C("",!0)]),t("p",De,[i[1]||(i[1]=t("strong",null,"Logout",-1)),H(" from "+b(o(f))+", or access your ",1),i[2]||(i[2]=t("strong",null,"Full Profile",-1)),H(" at "+b(_.value)+" (you may need to sign in again).",1)])])])]))}},xe=F(Ee,[["__scopeId","data-v-88828278"]]),Fe={class:"app-shell"},Te={class:"app-main"},ze={__name:"App",setup(V){const e=x(),f=m(!0),r=m("Loading..."),p=m(!1),y=m(!1);function w(a){if(!a)return null;const g=a.trim().toLowerCase();return g?g.replace(/:80$/,"").replace(/:443$/,""):null}const A=v(()=>{const a=e.settings?.auth_host;if(!a)return!1;const g=w(window.location.host),I=w(a);return g!==I});let _=null,c=null;async function S(){try{return e.userInfo=await E("/auth/api/user-info",{method:"POST"}),p.value=!0,f.value=!1,P(),!0}catch{return!1}}async function L(){u();const a=await Z("login");c=document.createElement("iframe"),c.id="auth-iframe",c.title="Authentication",c.allow="publickey-credentials-get; publickey-credentials-create",c.src=a,document.body.appendChild(c),r.value="Authentication required..."}function u(){c&&(c.remove(),c=null)}function i(){window.location.reload()}function h(a){const g=a.data;if(g?.type)switch(g.type){case"auth-success":u(),f.value=!0,r.value="Loading user profile...",S();break;case"auth-error":g.cancelled?console.log("Authentication cancelled by user"):e.showMessage(g.message||"Authentication failed","error",5e3);break;case"auth-cancelled":console.log("Authentication cancelled");break;case"auth-back":u(),f.value=!1,y.value=!0,e.showMessage("Authentication cancelled","info",3e3);break;case"auth-close-request":u();break}}async function B(){try{await E("/auth/api/validate",{method:"POST",credentials:"include"})}catch(a){a.status===401?(console.log("Session expired, requiring re-authentication"),p.value=!1,f.value=!0,M(),L()):console.error("Session validation error:",a)}}function P(){M(),_=setInterval(B,120*1e3)}function M(){_&&(clearInterval(_),_=null)}return T(async()=>{window.addEventListener("message",h),await e.loadSettings();const a=e.settings?.rp_name;if(a){const I=e.settings?.auth_host,D=I&&w(window.location.host)!==w(I);document.title=D?`${a} Â· Account summary`:a}await S()||L()}),z(()=>{window.removeEventListener("message",h),M(),u()}),(a,g)=>(l(),k("div",Fe,[N(re),t("main",Te,[p.value&&A.value?(l(),$(xe,{key:0,initializing:f.value},null,8,["initializing"])):p.value?(l(),$($e,{key:1})):f.value?(l(),$(le,{key:2,message:r.value},null,8,["message"])):y.value?(l(),$(ue,{key:3,onReload:i})):C("",!0)])]))}},q=ee(ze);q.use(de());q.mount("#app");
